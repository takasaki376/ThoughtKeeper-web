# MemoEditorPage 設計書

// filepath: doc/MemoEditorPage.md

## 1. 画面 UI 設計

### 構成要素

- **テーマ表示エリア**

  - 現在のテーマタイトル・内容を表示
  - 残りテーマ数・残り時間を表示

- **タブ切り替え**

  - `Tab`コンポーネントで「タイプ入力する」「手書きする」を切り替え
  - 選択中タブの状態は`activeTab`で管理
  - タブ切り替え時に DB へ`last_selected_input_type`を保存

- **入力エリア**

  - テキスト入力: `Tiptap`エディタ（リッチテキスト対応）
    - `editorRef`で自動フォーカス制御
    - 入力内容は`textContent`で管理
  - 手書き入力: `Drawing`コンポーネント（Canvas 描画）
    - 入力内容は`drawingContent`で管理
    - タッチ・マウス両対応

- **テーマ切り替え**

  - `handleThemeChange`で次のテーマへ移動
  - テーマ切り替え時に入力内容をリセット
  - 手書き入力があれば自動で「手書き」タブに切り替え

- **タイマー**
  - `useThemeTimer`フックで残り時間を管理
  - タイマー終了時に自動保存＆次テーマへ遷移

---

## 2. API 設計

### 設定取得・保存

- **`fetchSettings`**

  - ユーザー設定（テーマ数・制限時間・最終選択タブ）を取得
  - 初回マウント時にタブ状態復元

- **`updateSettings`**
  - タブ切り替え時に`last_selected_input_type`を保存
  - テーマ数・制限時間も同時に保存

---

### メモ保存

- **テキストメモ保存**

  - API: `PUT /api/memos`
  - リクエスト: `{ content, theme_id }`
  - レスポンス: `Memo`型
  - 保存後、同じテーマの既存メモを更新 or 新規追加
  - `recentMemosAtom`も同時更新

- **描画メモ保存**
  - API: `PUT /api/memos`
  - リクエスト: `{ title: "描画メモ", content, theme_id }`
  - レスポンス: `Memo`型
  - 保存後、同じテーマの既存メモを更新 or 新規追加
  - `recentMemosAtom`も同時更新

---

### その他

- **状態管理**

  - jotai でテーマ・メモリスト・最近のメモを管理
  - テーマ切り替えや保存時に atom を更新

- **エラーハンドリング**
  - 保存失敗時は`console.error`でログ出力
  - タイマー終了時の保存も例外処理あり

---

## 3. 補足

- 画面はレスポンシブ対応（PC/タブレット/スマホ）
- 入力欄は自動フォーカス・IME 変換確定後の保存も考慮
- タブ状態・テーマ状態は DB と同期
- API 通信は`ky`ライブラリで実装

---
